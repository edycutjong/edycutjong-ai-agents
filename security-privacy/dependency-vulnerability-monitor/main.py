import streamlit as st
import pandas as pd
import plotly.express as px
import os
from agent.parsers import DependencyParser
from agent.scanner import VulnerabilityScanner
from agent.generator import ReportGenerator, PRCreator
from agent.llm_advisor import RemediationAdvisor
from config import Config

# Custom CSS for Premium Look
def inject_custom_css():
    st.markdown("""
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        /* Global Styles */
        .stApp {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        h1, h2, h3 {
            font-family: 'Inter', sans-serif;
            color: #f8fafc;
        }

        /* Sidebar */
        [data-testid="stSidebar"] {
            background-color: #1e293b;
            border-right: 1px solid #334155;
        }

        /* Cards/Containers */
        .stCard {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* Buttons */
        .stButton > button {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
        }

        /* Metrics */
        [data-testid="stMetricValue"] {
            color: #3b82f6;
        }

        /* Expander */
        .streamlit-expanderHeader {
            background-color: #334155;
            color: white;
            border-radius: 4px;
        }
    </style>
    """, unsafe_allow_html=True)

def main():
    st.set_page_config(
        page_title="Dependency Vulnerability Monitor",
        page_icon="üõ°Ô∏è",
        layout="wide",
        initial_sidebar_state="expanded"
    )

    inject_custom_css()

    st.title("üõ°Ô∏è Dependency Vulnerability Monitor")
    st.markdown("Automated scanning, analysis, and remediation for project dependencies.")

    # Sidebar
    with st.sidebar:
        st.header("Configuration")
        api_key = st.text_input("OpenAI API Key", value=os.getenv("OPENAI_API_KEY", ""), type="password")
        if api_key:
            Config.OPENAI_API_KEY = api_key
            # Re-init advisor if key changes (simple way)

        st.divider()
        st.info("Supported files: package-lock.json, requirements.txt, Cargo.lock, go.mod")

        uploaded_file = st.file_uploader("Upload Lock File", type=["json", "txt", "lock", "mod"])

        if st.checkbox("Use Mock Data", value=Config.USE_MOCK_DATA):
            Config.USE_MOCK_DATA = True
        else:
            Config.USE_MOCK_DATA = False

    if not uploaded_file:
        st.info("üëà Please upload a dependency lock file to start scanning.")

        # Demo button
        if st.button("Load Demo Data"):
            # Create a fake file object or just run scan on dummy data
            pass # Simplified: User must upload for now, or we can pre-load a sample.
        return

    # Process File
    filename = uploaded_file.name
    content = uploaded_file.getvalue().decode("utf-8")

    try:
        # Parse
        with st.spinner(f"Parsing {filename}..."):
            dependencies = DependencyParser.parse_file(content, filename)

        st.success(f"Parsed {len(dependencies)} dependencies from {filename}.")

        # Scan
        with st.spinner("Scanning for vulnerabilities..."):
            scanner = VulnerabilityScanner()
            results = scanner.scan(dependencies)

        # Dashboard
        total_vulns = sum(len(v) for v in results.values())
        affected_deps = len(results)

        col1, col2, col3 = st.columns(3)
        col1.metric("Vulnerabilities Found", total_vulns)
        col2.metric("Affected Dependencies", affected_deps)
        col3.metric("Scanned Dependencies", len(dependencies))

        if not results:
            st.balloons()
            st.success("No vulnerabilities found! Your project is secure.")
            return

        # Prepare Data for Charts/Table
        data = []
        for dep, vulns in results.items():
            for v in vulns:
                data.append({
                    "Dependency": dep.name,
                    "Version": dep.version,
                    "CVE": v.cve_id,
                    "Severity": v.severity,
                    "Summary": v.summary,
                    "Fixed Version": v.fixed_version
                })

        df = pd.DataFrame(data)

        # Charts
        st.subheader("Analysis")
        col_chart1, col_chart2 = st.columns(2)

        with col_chart1:
            if "Severity" in df.columns:
                fig = px.pie(df, names='Severity', title='Severity Distribution', hole=0.4, color_discrete_sequence=px.colors.sequential.RdBu)
                st.plotly_chart(fig, use_container_width=True)

        with col_chart2:
            if "Dependency" in df.columns:
                fig = px.bar(df['Dependency'].value_counts().reset_index(), x='Dependency', y='count', title='Vulnerabilities per Dependency', labels={'count': 'Count'})
                st.plotly_chart(fig, use_container_width=True)

        # Detailed View & Remediation
        st.subheader("Vulnerabilities & Remediation")

        advisor = RemediationAdvisor()

        for dep, vulns in results.items():
            with st.expander(f"{dep.name} ({dep.version}) - {len(vulns)} Vulnerabilities"):
                col_left, col_right = st.columns([1, 1])

                with col_left:
                    st.markdown("#### Vulnerabilities")
                    for v in vulns:
                        st.markdown(f"**{v.cve_id}** [{v.severity}]")
                        st.markdown(f"_{v.summary}_")
                        st.markdown(f"Fixed in: `{v.fixed_version}`")
                        st.markdown("---")

                with col_right:
                    st.markdown("#### AI Remediation")
                    if st.button(f"Analyze & Suggest Fix for {dep.name}", key=f"btn_analyze_{dep.name}_{dep.version}"):
                        with st.spinner("Consulting Security Expert..."):
                            suggestion = advisor.suggest_fix(dep, vulns)
                            st.markdown(suggestion)

                            # Option to Create PR
                            fix_version = vulns[0].fixed_version if vulns else "latest"
                            pr_desc = advisor.generate_pr_description(dep, vulns, fix_version)

                            if st.button(f"Create Fix PR for {dep.name}", key=f"btn_pr_{dep.name}_{dep.version}"):
                                pr_url = PRCreator.create_pr(
                                    title=f"Security: Upgrade {dep.name} to {fix_version}",
                                    body=pr_desc
                                )
                                st.success(f"PR Created: [View Pull Request]({pr_url})")

        # Report Generation
        st.subheader("Reporting")
        if st.button("Generate Full Report"):
            generator = ReportGenerator()
            report_md = generator.generate_markdown(results)
            filepath = generator.save_report(report_md)
            st.success(f"Report saved to `{filepath}`")
            st.download_button("Download Report", report_md, file_name="security_report.md")

    except Exception as e:
        st.error(f"An error occurred: {e}")

if __name__ == "__main__":
    main()
