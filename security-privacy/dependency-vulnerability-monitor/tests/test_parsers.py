from agent.parsers import DependencyParser, Dependency

def test_parse_npm_v1():
    content = """
    {
        "dependencies": {
            "express": {
                "version": "4.17.1",
                "dependencies": {
                    "debug": {
                        "version": "2.6.9"
                    }
                }
            },
            "lodash": {
                "version": "4.17.21"
            }
        }
    }
    """
    deps = DependencyParser.parse_npm(content)
    assert len(deps) == 3
    names = [d.name for d in deps]
    assert "express" in names
    assert "lodash" in names
    assert "debug" in names

    express = next(d for d in deps if d.name == "express")
    assert express.version == "4.17.1"
    assert express.ecosystem == "npm"

def test_parse_npm_v2():
    content = """
    {
        "packages": {
            "": { "name": "my-app" },
            "node_modules/express": { "version": "4.18.2" },
            "node_modules/react": { "version": "18.2.0" }
        }
    }
    """
    deps = DependencyParser.parse_npm(content)
    assert len(deps) == 2
    names = [d.name for d in deps]
    assert "express" in names
    assert "react" in names

def test_parse_pip():
    content = """
    requests==2.28.1
    flask==2.2.2
    # comment
    gunicorn==20.1.0 # inline comment
    """
    deps = DependencyParser.parse_pip(content)
    assert len(deps) == 3
    names = [d.name for d in deps]
    assert "requests" in names
    assert "flask" in names
    assert "gunicorn" in names

    req = next(d for d in deps if d.name == "requests")
    assert req.version == "2.28.1"
    assert req.ecosystem == "pip"

def test_parse_cargo():
    content = """
    [[package]]
    name = "serde"
    version = "1.0.130"
    source = "registry+https://github.com/rust-lang/crates.io-index"

    [[package]]
    name = "tokio"
    version = "1.14.0"
    """
    deps = DependencyParser.parse_cargo(content)
    assert len(deps) == 2
    names = [d.name for d in deps]
    assert "serde" in names
    assert "tokio" in names

    serde = next(d for d in deps if d.name == "serde")
    assert serde.version == "1.0.130"
    assert serde.ecosystem == "cargo"

def test_parse_go():
    content = """
    module example.com/my/thing

    go 1.16

    require (
        github.com/gin-gonic/gin v1.7.7
        github.com/stretchr/testify v1.7.0
    )

    require golang.org/x/sys v0.0.0-20220412211240-33da011f77ad // indirect
    """
    deps = DependencyParser.parse_go(content)
    assert len(deps) == 3
    names = [d.name for d in deps]
    assert "github.com/gin-gonic/gin" in names
    assert "golang.org/x/sys" in names

    gin = next(d for d in deps if d.name == "github.com/gin-gonic/gin")
    assert gin.version == "v1.7.7"
    assert gin.ecosystem == "go"
