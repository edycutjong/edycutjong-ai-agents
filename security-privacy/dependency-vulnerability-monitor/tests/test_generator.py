import pytest
from agent.generator import ReportGenerator, PRCreator
from agent.parsers import Dependency
from agent.scanner import Vulnerability
from config import Config
import os

def test_generate_markdown():
    dep = Dependency("requests", "2.20.0", "pip")
    vuln = Vulnerability("CVE-2023-32681", "High vulnerability", "HIGH", "2.31.0")

    results = {dep: [vuln]}

    report = ReportGenerator.generate_markdown(results)

    assert "# Vulnerability Report" in report
    assert "requests (2.20.0)" in report
    assert "CVE-2023-32681" in report
    assert "High vulnerability" in report

def test_save_report(tmp_path):
    # Mock Config.REPORT_DIR
    original_report_dir = Config.REPORT_DIR
    Config.REPORT_DIR = str(tmp_path)

    report_content = "# Test Report"
    filepath = ReportGenerator.save_report(report_content, "test.md")

    assert os.path.exists(filepath)
    with open(filepath, "r") as f:
        assert f.read() == report_content

    Config.REPORT_DIR = original_report_dir

def test_create_pr():
    title = "Fix Vulnerabilities"
    body = "Upgrade packages"

    url = PRCreator.create_pr(title, body)
    assert url.startswith("https://github.com/user/repo/pull/")
