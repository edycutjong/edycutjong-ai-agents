import pytest
from unittest.mock import patch, MagicMock
from agent.scanner import VulnerabilityScanner, Vulnerability
from agent.parsers import Dependency
from config import Config

def test_mock_scan():
    Config.USE_MOCK_DATA = True
    scanner = VulnerabilityScanner()

    # Test requests mock
    dep_bad = Dependency("requests", "2.20.0", "pip")
    res = scanner.check_vulnerability(dep_bad)
    assert len(res) > 0
    assert res[0].cve_id == "CVE-2023-32681"

    # Test requests safe
    dep_good = Dependency("requests", "2.31.0", "pip")
    res = scanner.check_vulnerability(dep_good)
    assert len(res) == 0

    # Test unknown
    dep_unk = Dependency("foo", "1.0.0", "pip")
    res = scanner.check_vulnerability(dep_unk)
    assert len(res) == 0

@patch("agent.scanner.requests.post")
def test_osv_scan(mock_post):
    Config.USE_MOCK_DATA = False
    scanner = VulnerabilityScanner()

    mock_response = MagicMock()
    mock_response.status_code = 200
    mock_response.json.return_value = {
        "vulns": [
            {
                "id": "GHSA-1234",
                "aliases": ["CVE-2022-5678"],
                "summary": "Bad thing",
                "details": "Very bad",
                "severity": [
                    {
                        "type": "CVSS_V3",
                        "score": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
                    }
                ],
                "affected": [
                    {
                        "ranges": [
                            {
                                "events": [
                                    { "fixed": "1.2.3" }
                                ]
                            }
                        ]
                    }
                ]
            }
        ]
    }
    mock_post.return_value = mock_response

    dep = Dependency("vulnerable-pkg", "1.0.0", "npm")
    res = scanner.check_vulnerability(dep)

    assert len(res) == 1
    assert res[0].cve_id == "CVE-2022-5678"
    assert res[0].fixed_version == "1.2.3"
    assert res[0].severity == "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
