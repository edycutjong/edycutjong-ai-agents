import os
import datetime
from typing import Dict, List
from agent.parsers import Dependency
from agent.scanner import Vulnerability
from config import Config

class ReportGenerator:

    @staticmethod
    def generate_markdown(results: Dict[Dependency, List[Vulnerability]]) -> str:
        report = f"# Vulnerability Report\n\n"
        report += f"**Date:** {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"

        if not results:
            report += "No vulnerabilities found.\n"
            return report

        report += f"Found vulnerabilities in {len(results)} dependencies.\n\n"

        for dep, vulns in results.items():
            report += f"## {dep.name} ({dep.version})\n"
            report += f"**Ecosystem:** {dep.ecosystem}\n\n"

            for v in vulns:
                report += f"- **{v.cve_id}** (Severity: {v.severity})\n"
                report += f"  - **Summary:** {v.summary}\n"
                report += f"  - **Fixed in:** {v.fixed_version}\n"
                report += f"  - **Details:** {v.description[:200]}...\n\n"

        return report

    @staticmethod
    def save_report(content: str, filename: str = "vulnerability_report.md"):
        os.makedirs(Config.REPORT_DIR, exist_ok=True)
        filepath = os.path.join(Config.REPORT_DIR, filename)
        with open(filepath, "w") as f:
            f.write(content)
        return filepath

class PRCreator:

    @staticmethod
    def create_pr(title: str, body: str, branch: str = "fix/vulnerabilities") -> str:
        """
        Mock function to simulate creating a Pull Request.
        In a real scenario, this would use GitHub API (PyGithub) or GitLab API.
        """
        # Simulate API call latency? No need.

        # Mock PR URL
        pr_number = hash(title) % 1000
        repo_url = "https://github.com/user/repo"
        pr_url = f"{repo_url}/pull/{pr_number}"

        print(f"[MOCK] Creating PR: {title}")
        print(f"[MOCK] Branch: {branch}")
        print(f"[MOCK] Body: {body[:50]}...")

        return pr_url
