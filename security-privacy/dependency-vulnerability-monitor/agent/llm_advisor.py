import os
from typing import List, Dict
from langchain_openai import ChatOpenAI
from langchain.prompts import PromptTemplate
from agent.parsers import Dependency
from agent.scanner import Vulnerability
from config import Config

class RemediationAdvisor:

    def __init__(self):
        self.api_key = Config.OPENAI_API_KEY
        self.llm = None
        if self.api_key:
            try:
                self.llm = ChatOpenAI(
                    api_key=self.api_key,
                    model=Config.get_llm_config()["model"],
                    temperature=Config.get_llm_config()["temperature"]
                )
            except Exception:
                # Fallback if init fails (e.g. invalid key format)
                pass

    def suggest_fix(self, dep: Dependency, vulns: List[Vulnerability]) -> str:
        if not self.llm:
            return self._mock_suggestion(dep, vulns)

        vuln_summaries = "\n".join([f"- {v.cve_id}: {v.summary} (Severity: {v.severity})" for v in vulns])

        prompt_template = """
        You are a security expert. Analyze the following vulnerabilities for the dependency '{dep_name}' (version {dep_version}) in the {ecosystem} ecosystem.

        Vulnerabilities:
        {vuln_summaries}

        Suggest a remediation plan.
        1. Identify the safe version to upgrade to.
        2. Explain why the upgrade is necessary.
        3. Provide the command to upgrade.

        Keep it concise.
        """

        prompt = PromptTemplate(
            input_variables=["dep_name", "dep_version", "ecosystem", "vuln_summaries"],
            template=prompt_template
        )

        chain = prompt | self.llm
        try:
            response = chain.invoke({
                "dep_name": dep.name,
                "dep_version": dep.version,
                "ecosystem": dep.ecosystem,
                "vuln_summaries": vuln_summaries
            })
            return response.content
        except Exception as e:
            return f"Error generating suggestion: {e}"

    def generate_pr_description(self, dep: Dependency, vulns: List[Vulnerability], fix_version: str) -> str:
        if not self.llm:
            return self._mock_pr_description(dep, vulns, fix_version)

        vuln_list = ", ".join([v.cve_id for v in vulns])

        prompt_template = """
        Generate a Pull Request description for upgrading '{dep_name}' from version {dep_version} to {fix_version}.
        This upgrade fixes the following vulnerabilities: {vuln_list}.

        The description should include:
        - Summary of changes
        - List of fixed vulnerabilities
        - Impact assessment (e.g. breaking changes risk)

        Format as Markdown.
        """

        prompt = PromptTemplate(
            input_variables=["dep_name", "dep_version", "fix_version", "vuln_list"],
            template=prompt_template
        )

        chain = prompt | self.llm
        try:
            response = chain.invoke({
                "dep_name": dep.name,
                "dep_version": dep.version,
                "fix_version": fix_version,
                "vuln_list": vuln_list
            })
            return response.content
        except Exception as e:
            return f"Error generating PR description: {e}"

    def _mock_suggestion(self, dep: Dependency, vulns: List[Vulnerability]) -> str:
        fix_version = vulns[0].fixed_version if vulns and vulns[0].fixed_version != "UNKNOWN" else "latest"
        return f"""
**Remediation Plan for {dep.name}**

Upgrade `{dep.name}` from `{dep.version}` to `{fix_version}`.

**Reasoning:**
Fixes {len(vulns)} vulnerabilities, including {vulns[0].cve_id if vulns else 'unknown CVEs'}.

**Command:**
```bash
# If npm
npm install {dep.name}@{fix_version}

# If pip
pip install {dep.name}=={fix_version}
```
"""

    def _mock_pr_description(self, dep: Dependency, vulns: List[Vulnerability], fix_version: str) -> str:
        vuln_items = "\n".join([f"- {v.cve_id}: {v.summary}" for v in vulns])
        return f"""
# Security Upgrade: {dep.name} to {fix_version}

This PR upgrades `{dep.name}` to version `{fix_version}` to fix known security vulnerabilities.

## Fixed Vulnerabilities
{vuln_items}

## Impact
Please test this upgrade in a staging environment before merging.
"""
