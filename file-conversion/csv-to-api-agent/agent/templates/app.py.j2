from flask import Flask, request, jsonify
from flasgger import Swagger
from database import db
from models import Item
import pandas as pd
import os

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///db.sqlite'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db.init_app(app)
swagger = Swagger(app)

with app.app_context():
    db.create_all()
    # Seed data if empty
    if not Item.query.first():
        if os.path.exists('data.csv'):
            try:
                # Naive CSV reading - assumes format matches what Analyzer saw
                df = pd.read_csv('data.csv')
                # Handle dates if necessary (simplified)
                {% for col in columns %}
                {% if col.type == 'datetime' %}
                if '{{ col.original_name }}' in df.columns:
                    df['{{ col.original_name }}'] = pd.to_datetime(df['{{ col.original_name }}'])
                {% endif %}
                {% endfor %}

                for _, row in df.iterrows():
                    item = Item(
                        {% for col in columns %}
                        {{ col.name }}=row['{{ col.original_name }}'] if not pd.isna(row['{{ col.original_name }}']) else None,
                        {% endfor %}
                    )
                    db.session.add(item)
                db.session.commit()
                print("Database seeded from data.csv")
            except Exception as e:
                print(f"Failed to seed database: {e}")

@app.route('/items', methods=['GET'])
def get_items():
    """
    Get all items with pagination and filtering
    ---
    parameters:
      - name: page
        in: query
        type: integer
        default: 1
      - name: per_page
        in: query
        type: integer
        default: 10
      {% for col in columns %}
      - name: {{ col.name }}
        in: query
        type: {{ col.api_type }}
        description: Filter by {{ col.name }}
      {% endfor %}
    responses:
      200:
        description: A list of items
    """
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 10, type=int)

    query = Item.query

    # Filtering
    {% for col in columns %}
    val_{{ col.name }} = request.args.get('{{ col.name }}')
    if val_{{ col.name }}:
        query = query.filter(Item.{{ col.name }} == val_{{ col.name }})
    {% endfor %}

    pagination = query.paginate(page=page, per_page=per_page, error_out=False)

    return jsonify({
        'total': pagination.total,
        'pages': pagination.pages,
        'page': page,
        'items': [item.to_dict() for item in pagination.items]
    })

@app.route('/items', methods=['POST'])
def create_item():
    """
    Create a new item
    ---
    parameters:
      - name: body
        in: body
        required: true
        schema:
          type: object
          properties:
            {% for col in columns %}
            {{ col.name }}:
              type: {{ col.api_type }}
            {% endfor %}
    responses:
      201:
        description: Item created
    """
    data = request.json
    new_item = Item(
        {% for col in columns %}
        {{ col.name }}=data.get('{{ col.name }}'),
        {% endfor %}
    )
    db.session.add(new_item)
    db.session.commit()
    return jsonify(new_item.to_dict()), 201

@app.route('/items/<int:id>', methods=['GET'])
def get_item(id):
    """
    Get an item by ID
    ---
    parameters:
      - name: id
        in: path
        type: integer
        required: true
    responses:
      200:
        description: Item found
      404:
        description: Item not found
    """
    item = Item.query.get_or_404(id)
    return jsonify(item.to_dict())

@app.route('/items/<int:id>', methods=['PUT'])
def update_item(id):
    """
    Update an item
    ---
    parameters:
      - name: id
        in: path
        type: integer
        required: true
      - name: body
        in: body
        required: true
        schema:
          type: object
          properties:
            {% for col in columns %}
            {{ col.name }}:
              type: {{ col.api_type }}
            {% endfor %}
    responses:
      200:
        description: Item updated
    """
    item = Item.query.get_or_404(id)
    data = request.json

    {% for col in columns %}
    if '{{ col.name }}' in data:
        item.{{ col.name }} = data['{{ col.name }}']
    {% endfor %}

    db.session.commit()
    return jsonify(item.to_dict())

@app.route('/items/<int:id>', methods=['DELETE'])
def delete_item(id):
    """
    Delete an item
    ---
    parameters:
      - name: id
        in: path
        type: integer
        required: true
    responses:
      204:
        description: Item deleted
    """
    item = Item.query.get_or_404(id)
    db.session.delete(item)
    db.session.commit()
    return '', 204

if __name__ == '__main__':
    app.run(debug=True)
